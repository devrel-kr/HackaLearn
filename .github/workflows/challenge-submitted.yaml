name: On Challenge Submitted

on:
  # pull_request:
  #   types:
  #   - opened
  #   branches:
  #   - main
  #   paths:
  #   - 'teams/**/*.md'
  pull_request_target:
    types:
    - opened
    branches:
    - main
    paths:
    - 'teams/**/*.md'

jobs:
  labelling:
    name: 'Add a label on submission: review-required'

    runs-on: ubuntu-latest

    steps:
    - name: Get PR date/time
      id: checkpoint
      shell: pwsh
      run: |
        $tz = [TimeZoneInfo]::FindSystemTimeZoneById("Asia/Seoul")
        $dateSubmitted = [DateTimeOffset]::Parse("${{ github.event.pull_request.created_at }}")
        $offset = $tz.GetUtcOffset($dateSubmitted)

        $dateSubmitted = $dateSubmitted.ToOffset($offset)
        $dateDue = $([DateTimeOffset]::Parse("2021-08-16T00:00:00.000+09:00"))
        $isOverdue = "$($dateSubmitted -gt $dateDue)".ToLowerInvariant()

        $dateSubmittedValue = $dateSubmitted.ToString("yyyy-MM-ddTHH:mm:ss.fffzzz")
        $dateDueValue = $dateDue.ToString("yyyy-MM-ddTHH:mm:ss.fffzzz")

        echo "::set-output name=dateSubmitted::$dateSubmittedValue"
        echo "::set-output name=dateDue::$dateDueValue"
        echo "::set-output name=isOverdue::$isOverdue"

    - name: Add a label - Overdue
      if: ${{ steps.checkpoint.outputs.isOverdue == 'true' }}
      uses: buildsville/add-remove-label@v1
      with:
        token: "${{ secrets.GITHUB_TOKEN }}"
        label: 'OVERDUE-SUBMIT'
        type: add

    - name: Comment to PR - Overdue
      if: ${{ steps.checkpoint.outputs.isOverdue == 'true' }}
      uses: bubkoo/auto-comment@v1
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        pullRequestOpened: |
          ğŸ‘‹ğŸ¼ @{{ author }} ë‹˜!

          * PR ì œì¶œ ì‹œê°: ${{ steps.checkpoint.outputs.dateSubmitted }}
          * PR ë§ˆê° ì‹œê°: ${{ steps.checkpoint.outputs.dateDue }}

          ì•ˆíƒ€ê¹ê²Œë„ ì œì¶œí•˜ì‹  PRì€ ë§ˆê° ê¸°í•œì¸ ${{ steps.checkpoint.outputs.dateDue }}ì„ ë„˜ê¸°ì…¨ìŠµë‹ˆë‹¤. ğŸ˜­ ë”°ë¼ì„œ, ì´ë²ˆ HackaLearn ì´ë²¤íŠ¸ì— ë°˜ì˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

          ê·¸ë™ì•ˆ HackaLearn ì´ë²¤íŠ¸ì— ì°¸ì—¬í•´ ì£¼ì…”ì„œ ê°ì‚¬ ë“œë¦½ë‹ˆë‹¤. ë‹¤ìŒ ê¸°íšŒì— ë‹¤ì‹œ ë§Œë‚˜ìš”!

    - name: Close PR - Overdue
      if: ${{ steps.checkpoint.outputs.isOverdue == 'true' }}
      uses: superbrothers/close-pull-request@v3
      with:
        comment: "ì œì¶œ ê¸°í•œ ì¢…ë£Œ"

    - name: Add a label
      if: ${{ steps.checkpoint.outputs.isOverdue == 'false' }}
      uses: actions/labeler@v3
      with:
        repo-token: "${{ secrets.GITHUB_TOKEN }}"
        configuration-path: '.github/labeler.yml'

    - name: Comment to PR
      if: ${{ steps.checkpoint.outputs.isOverdue == 'false' }}
      uses: bubkoo/auto-comment@v1
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        pullRequestOpenedReactions: 'rocket, +1'
        pullRequestOpened: >
          ğŸ‘‹ğŸ¼ @{{ author }} ë‹˜!
          <br>
          ì±Œë¦°ì§€ ì™„ë£Œ PRë¥¼ ìƒì„±í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ‰ ì°¸ê°€ìë‹˜ì˜ í•´ì»¤í†¤ ì™„ì£¼ë¥¼ ì‘ì›í•´ìš”! ğŸ’ªğŸ¼
          <br>
          PR í…œí”Œë¦¿ ì‘ì„± ê°€ì´ë“œë¼ì¸ì„ ì˜ ì¤€ìˆ˜í•˜ì…¨ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”. ìµœëŒ€í•œ ë¹ ë¥´ê²Œ ë¦¬ë·°í•˜ê² ìŠµë‹ˆë‹¤! ğŸ˜Š
          <br><br>
          ğŸ”¹ From. HackaLearn ìš´ì˜ì§„ ì¼ë™ ğŸ”¹

    - name: Randomly assign a staff
      if: ${{ steps.checkpoint.outputs.isOverdue == 'false' }}
      uses: gerardabello/auto-assign@v1.0.1
      with:
        github-token: "${{ secrets.GITHUB_TOKEN }}"
        number-of-assignees: 1
        assignee-pool: "${{ secrets.PR_REVIEWERS }}"
